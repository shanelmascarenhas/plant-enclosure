<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Control</title>
    <style>
        :root { --bg: #0b0f0c; --text: rgba(255,255,255,0.92); --muted: rgba(255,255,255,0.6); --radius: 20px; 
                --c-temp: #ff6b6b; --c-water: #4fc3f7; --c-light: #ffeb3b; --c-sys: #ba68c8; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; padding: 30px 20px 80px 20px; display: flex; flex-direction: column; align-items: center; }
        
        .header { max-width: 600px; width: 100%; margin: 0 auto 30px auto; text-align: center; position: relative; }
        .back-btn { position: absolute; left: 0; top: 50%; transform: translateY(-50%); color: var(--muted); text-decoration: none; font-size: 14px; }
        h2 { margin: 0; font-weight: 300; font-size: 28px; }

        .form-container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 20px; }
        
        /* Modern Glass Cards with glowing borders */
        .card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--radius); padding: 24px; backdrop-filter: blur(20px); position: relative; overflow: hidden; }
        .card::before { content: ""; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
        .card.card-temp::before { background: var(--c-temp); box-shadow: 0 0 15px var(--c-temp); }
        .card.card-water::before { background: var(--c-water); box-shadow: 0 0 15px var(--c-water); }
        .card.card-light::before { background: var(--c-light); box-shadow: 0 0 15px var(--c-light); }
        .card.card-sys::before { background: var(--c-sys); box-shadow: 0 0 15px var(--c-sys); }

        .group-title { font-size: 13px; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 24px; font-weight: 700; color: #fff; opacity: 0.8;}
        
        /* Custom Inputs */
        .ip-input { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 14px; border-radius: 12px; font-size: 16px; outline: none; font-family: monospace; box-sizing: border-box;}
        
        /* Sliders */
        .slider-container { margin-bottom: 28px; }
        .slider-labels { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 12px; color: var(--muted); }
        .slider-labels span.val { font-weight: bold; color: white; font-size: 16px;}
        
        .dual-slider { position: relative; width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 10px; }
        .slider-track { position: absolute; height: 100%; border-radius: 3px; z-index: 1; }
        .dual-slider input[type="range"] { position: absolute; width: 100%; -webkit-appearance: none; background: none; pointer-events: none; top: -6px; z-index: 2; margin: 0; }
        .dual-slider input[type="range"]::-webkit-slider-thumb { pointer-events: auto; -webkit-appearance: none; width: 20px; height: 20px; background: #111; border: 2px solid white; border-radius: 50%; cursor: pointer; transition: transform 0.1s; }
        .dual-slider input[type="range"]::-webkit-slider-thumb:active { transform: scale(1.2); }

        /* Themed Tracks */
        .card-temp .slider-track { background: var(--c-temp); }
        .card-temp .dual-slider input[type="range"]::-webkit-slider-thumb { border-color: var(--c-temp); }
        .card-water .slider-track { background: var(--c-water); }
        .card-water .dual-slider input[type="range"]::-webkit-slider-thumb { border-color: var(--c-water); }
        .card-light .slider-track { background: var(--c-light); }
        .card-light .dual-slider input[type="range"]::-webkit-slider-thumb { border-color: var(--c-light); }
        .card-sys .slider-track { background: var(--c-sys); }
        .card-sys .dual-slider input[type="range"]::-webkit-slider-thumb { border-color: var(--c-sys); }

        /* iOS Style Toggle Switch */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-tog { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.2); transition: .3s; border-radius: 30px; }
        .slider-tog:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider-tog { background-color: var(--c-light); }
        input:checked + .slider-tog:before { transform: translateX(22px); background-color: #000; }

        .btn-push { position: sticky; bottom: 20px; width: 100%; max-width: 600px; background: rgba(255,255,255,0.95); color: #000; border: none; padding: 18px; border-radius: 16px; font-weight: 700; font-size: 16px; cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 10; transition: 0.2s;}
        .btn-push:active { transform: scale(0.98); }
        #statusMsg { text-align: center; font-size: 13px; margin-top: 15px; color: var(--muted); }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html" class="back-btn">‚Üê Home</a>
        <h2>Control Panel</h2>
    </div>

    <div class="form-container" id="formWrapper">
        
        <div class="card card-sys">
            <div class="group-title">üîå Connection & System</div>
            <input type="text" class="ip-input" id="espIp" placeholder="ESP32 IP (e.g. 192.168.1.50)">
            <br><br>
            <div class="slider-container" style="margin-bottom:0;">
                <div class="slider-labels"><span>Screen Brightness</span> <span class="val" id="brightVal">10 / 10</span></div>
                <div class="dual-slider"><div class="slider-track" id="brightTrack" style="width:100%"></div>
                    <input type="range" id="globalBrightness" min="1" max="10" value="10" oninput="updateSingles()">
                </div>
            </div>
        </div>

        <div class="card card-temp">
            <div class="group-title">üå°Ô∏è Climate Range</div>
            <div class="slider-container">
                <div class="slider-labels"><span>Temperature</span> <span class="val" id="tempVal">65¬∞F - 85¬∞F</span></div>
                <div class="dual-slider">
                    <div class="slider-track" id="tempTrack"></div>
                    <input type="range" id="tempLow" min="40" max="100" step="1" oninput="updateSliders('temp')">
                    <input type="range" id="tempHigh" min="40" max="100" step="1" oninput="updateSliders('temp')">
                </div>
            </div>
        </div>

        <div class="card card-water">
            <div class="group-title">üíß Moisture & Humidity</div>
            <div class="slider-container">
                <div class="slider-labels"><span>Humidity Target</span> <span class="val" id="humVal">40% - 60%</span></div>
                <div class="dual-slider">
                    <div class="slider-track" id="humTrack"></div>
                    <input type="range" id="humLow" min="0" max="100" step="1" oninput="updateSliders('hum')">
                    <input type="range" id="humHigh" min="0" max="100" step="1" oninput="updateSliders('hum')">
                </div>
            </div>
            <div class="slider-container" style="margin-bottom:0;">
                <div class="slider-labels"><span>Soil Moisture Target</span> <span class="val" id="soilVal">20% - 50%</span></div>
                <div class="dual-slider">
                    <div class="slider-track" id="soilTrack"></div>
                    <input type="range" id="soilLow" min="0" max="100" step="1" oninput="updateSliders('soil')">
                    <input type="range" id="soilHigh" min="0" max="100" step="1" oninput="updateSliders('soil')">
                </div>
            </div>
        </div>

        <div class="card card-light">
            <div class="group-title">üåû Lighting Schedule</div>
            
            <div class="toggle-row">
                <div style="font-size:14px; color:var(--muted)">Enable Grow Light Timer</div>
                <label class="switch"><input type="checkbox" id="timerEnabled"><span class="slider-tog"></span></label>
            </div>

            <div class="slider-container">
                <div class="slider-labels"><span>Turn On Time</span> <span class="val" id="onVal">08:00</span></div>
                <div class="dual-slider"><div class="slider-track" style="width:100%"></div>
                    <input type="range" id="timeOnHour" min="0" max="23" value="8" oninput="updateSingles()">
                </div>
            </div>
            <div class="slider-container">
                <div class="slider-labels"><span>Turn Off Time</span> <span class="val" id="offVal">20:00</span></div>
                <div class="dual-slider"><div class="slider-track" style="width:100%"></div>
                    <input type="range" id="timeOffHour" min="0" max="23" value="20" oninput="updateSingles()">
                </div>
            </div>
            <div class="slider-container" style="margin-bottom:0;">
                <div class="slider-labels"><span>Lux Auto-on Threshold</span> <span class="val" id="luxVal">30000 lux</span></div>
                <div class="dual-slider"><div class="slider-track" style="width:100%"></div>
                    <input type="range" id="luxThreshold" min="0" max="100000" step="1000" value="30000" oninput="updateSingles()">
                </div>
            </div>
        </div>

    </div>

    <button class="btn-push" id="sendBtn">Sync Enclosure Data üì°</button>
    <div id="statusMsg">Ready.</div>

    <script>
        const FIREBASE_URL = "https://plant-enclosure-default-rtdb.firebaseio.com/settings.json"; 

        const inputs = {
            espIp: document.getElementById("espIp"), tempLow: document.getElementById("tempLow"), tempHigh: document.getElementById("tempHigh"),
            humLow: document.getElementById("humLow"), humHigh: document.getElementById("humHigh"), soilLow: document.getElementById("soilLow"),
            soilHigh: document.getElementById("soilHigh"), timeOnHour: document.getElementById("timeOnHour"), timeOffHour: document.getElementById("timeOffHour"), 
            luxThreshold: document.getElementById("luxThreshold"), timerEnabled: document.getElementById("timerEnabled"), globalBrightness: document.getElementById("globalBrightness")
        };

        try { const savedIp = localStorage.getItem("esp32_ip"); if (savedIp) inputs.espIp.value = savedIp; } catch(e) {}

        function updateSliders(type) {
            const low = document.getElementById(type + "Low"); const high = document.getElementById(type + "High");
            const track = document.getElementById(type + "Track"); const label = document.getElementById(type + "Val");
            const suffix = type === 'temp' ? '¬∞F' : '%';
            let minV = parseInt(low.value); let maxV = parseInt(high.value);
            if (minV >= maxV) { low.value = maxV - 1; minV = maxV - 1; }
            const minBound = parseInt(low.min); const maxBound = parseInt(low.max);
            const p1 = ((minV - minBound) / (maxBound - minBound)) * 100;
            const p2 = ((maxV - minBound) / (maxBound - minBound)) * 100;
            track.style.left = p1 + "%"; track.style.width = (p2 - p1) + "%";
            label.textContent = `${minV}${suffix} - ${maxV}${suffix}`;
        }

        function updateSingles() {
            document.getElementById("onVal").textContent = document.getElementById("timeOnHour").value.padStart(2, '0') + ":00";
            document.getElementById("offVal").textContent = document.getElementById("timeOffHour").value.padStart(2, '0') + ":00";
            document.getElementById("luxVal").textContent = document.getElementById("luxThreshold").value + " lux";
            document.getElementById("brightVal").textContent = document.getElementById("globalBrightness").value + " / 10";
        }

        async function fetchCurrentSettings() {
            try {
                const res = await fetch(FIREBASE_URL, { cache: "no-store" });
                const d = await res.json();
                if (d && d.tempLow !== undefined) {
                    for (const key in d) { 
                        if (inputs[key] !== undefined) {
                            if (key === 'timerEnabled') inputs[key].checked = d[key];
                            else inputs[key].value = d[key];
                        }
                    }
                }
                updateSliders('temp'); updateSliders('hum'); updateSliders('soil'); updateSingles();
            } catch (err) { document.getElementById("statusMsg").textContent = "Could not load current cloud settings."; }
        }

        document.getElementById("sendBtn").addEventListener("click", async () => {
            let targetIp = inputs.espIp.value.trim();
            if (!targetIp) { alert("Please enter the ESP32 IP Address!"); inputs.espIp.focus(); return; }
            if (!targetIp.startsWith("http")) targetIp = "http://" + targetIp;

            const sendBtn = document.getElementById("sendBtn");
            const statusMsg = document.getElementById("statusMsg");

            sendBtn.disabled = true; sendBtn.textContent = "Syncing...";
            try { localStorage.setItem("esp32_ip", inputs.espIp.value.trim()); } catch(e) {}

            try {
                const newSettings = {
                    tempLow: parseFloat(inputs.tempLow.value), tempHigh: parseFloat(inputs.tempHigh.value),
                    humLow: parseFloat(inputs.humLow.value), humHigh: parseFloat(inputs.humHigh.value),
                    soilLow: parseInt(inputs.soilLow.value), soilHigh: parseInt(inputs.soilHigh.value),
                    timeOnHour: parseInt(inputs.timeOnHour.value), timeOffHour: parseInt(inputs.timeOffHour.value),
                    luxThreshold: parseInt(inputs.luxThreshold.value), timerEnabled: inputs.timerEnabled.checked,
                    globalBrightness: parseInt(inputs.globalBrightness.value)
                };

                statusMsg.textContent = "Pushing to Hardware...";
                const espRes = await fetch(`${targetIp}/settings`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(newSettings) });
                if (!espRes.ok) throw new Error("Hardware refused connection.");

                statusMsg.textContent = "Updating Cloud Database...";
                // PATCH prevents overwriting un-related fields
                const putResp = await fetch(FIREBASE_URL, { method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify(newSettings) });
                if (!putResp.ok) throw new Error("Cloud Sync Failed");

                statusMsg.textContent = "‚úÖ System Fully Synchronized!";
                sendBtn.textContent = "Sync Complete"; sendBtn.style.background = "#4fc3f7"; 
                setTimeout(() => { sendBtn.disabled = false; sendBtn.textContent = "Sync Enclosure Data üì°"; sendBtn.style.background = ""; }, 3000);
            } catch (err) {
                statusMsg.textContent = `‚ùå ${err.message}`; sendBtn.disabled = false; sendBtn.textContent = "Try Again";
            }
        });

        window.onload = fetchCurrentSettings;
    </script>
</body>
</html>