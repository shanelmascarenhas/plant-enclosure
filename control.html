<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Control</title>
    <style>
        :root { --bg: #0b0f0c; --card: rgba(255,255,255,0.05); --text: rgba(255,255,255,0.92); --muted: rgba(255,255,255,0.6); --stroke: rgba(255,255,255,0.12); --radius: 18px; --accent: #4f99ff; }
        body { margin: 0; background: radial-gradient(1200px 800px at 85% 20%, rgba(79, 153, 255, 0.15), transparent 60%), var(--bg); color: var(--text); font-family: system-ui, sans-serif; padding: 30px 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .header { max-width: 600px; width: 100%; margin: 0 auto 30px auto; text-align: center; position: relative; }
        .back-btn { position: absolute; left: 0; top: 50%; transform: translateY(-50%); color: var(--muted); text-decoration: none; font-size: 14px; }
        h2 { margin: 0; font-weight: 400; font-size: 26px; }
        .form-container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 20px; }
        .control-group { background: var(--card); border: 1px solid var(--stroke); border-radius: var(--radius); padding: 24px; backdrop-filter: blur(10px); }
        .group-title { font-size: 14px; text-transform: uppercase; color: var(--accent); margin-bottom: 24px; font-weight: 700; }
        
        /* Dual Slider Style */
        .slider-wrap { position: relative; height: 50px; margin-top: 10px; }
        .slider-wrap input[type="range"] { position: absolute; width: 100%; pointer-events: none; appearance: none; background: none; }
        .slider-wrap input[type="range"]::-webkit-slider-thumb { height: 20px; width: 20px; border-radius: 50%; background: #fff; pointer-events: auto; appearance: none; cursor: pointer; border: 2px solid var(--accent); }
        .track { position: absolute; width: 100%; height: 6px; background: rgba(255,255,255,0.1); top: 7px; border-radius: 3px; }
        .label-row { display: flex; justify-content: space-between; font-size: 14px; color: var(--muted); }
        .val-text { font-weight: bold; color: #fff; }

        .input-box input[type="text"] { background: rgba(0,0,0,0.3); border: 1px solid var(--stroke); color: white; padding: 12px; border-radius: 12px; width: 100%; outline: none; }
        .btn { background: rgba(79, 153, 255, 0.2); border: 1px solid rgba(79, 153, 255, 0.4); color: white; padding: 16px; border-radius: 14px; font-weight: 600; cursor: pointer; width: 100%; }
        #statusMsg { text-align: center; font-size: 13px; margin-top: 12px; color: var(--muted); }
    </style>
</head>
<body>
    <div class="header"><a href="index.html" class="back-btn">‚Üê Home</a><h2>Control Panel</h2></div>
    <div class="form-container">
        <div class="control-group">
            <div class="group-title">üîå Connection</div>
            <input type="text" id="espIp" placeholder="ESP32 IP (e.g. 192.168.1.50)">
        </div>

        <div class="control-group">
            <div class="group-title">üå°Ô∏è Range Settings</div>
            
            <div class="label-row"><span>Temperature</span><span class="val-text" id="tDisp">--</span></div>
            <div class="slider-wrap">
                <div class="track"></div>
                <input type="range" id="tLow" min="40" max="100" step="1" oninput="updateUI()">
                <input type="range" id="tHigh" min="40" max="100" step="1" oninput="updateUI()">
            </div>

            <div class="label-row"><span>Humidity</span><span class="val-text" id="hDisp">--</span></div>
            <div class="slider-wrap">
                <div class="track"></div>
                <input type="range" id="hLow" min="0" max="100" step="1" oninput="updateUI()">
                <input type="range" id="hHigh" min="0" max="100" step="1" oninput="updateUI()">
            </div>
        </div>

        <button class="btn" onclick="pushSettings()">üì° Push to Enclosure</button>
        <div id="statusMsg">Ready.</div>
    </div>

    <script>
        const FB = "https://plant-enclosure-default-rtdb.firebaseio.com/settings.json";
        
        function updateUI() {
            // Fix overlapping thumbs
            if(parseInt(tLow.value) > parseInt(tHigh.value)) tLow.value = tHigh.value;
            if(parseInt(hLow.value) > parseInt(hHigh.value)) hLow.value = hHigh.value;
            
            document.getElementById('tDisp').textContent = `${tLow.value}¬∞F - ${tHigh.value}¬∞F`;
            document.getElementById('hDisp').textContent = `${hLow.value}% - ${hHigh.value}%`;
        }

        async function pushSettings() {
            const ip = document.getElementById('espIp').value.trim();
            if(!ip) return alert("Enter IP first!");
            localStorage.setItem("esp32_ip", ip);
            
            const settings = {
                tempLow: parseFloat(tLow.value), tempHigh: parseFloat(tHigh.value),
                humLow: parseFloat(hLow.value), humHigh: parseFloat(hHigh.value),
                soilLow: 20, soilHigh: 50, timeOnHour: 8, timeOffHour: 20, luxThreshold: 30000
            };

            const status = document.getElementById('statusMsg');
            status.textContent = "Updating...";

            try {
                // Save to Cloud
                await fetch(FB, { method: "PUT", body: JSON.stringify(settings) });
                // Save to ESP32
                const url = ip.startsWith('http') ? `${ip}/settings` : `http://${ip}/settings`;
                await fetch(url, { method: "POST", body: JSON.stringify(settings) });
                status.textContent = "‚úÖ Success!";
            } catch(e) { status.textContent = "‚ùå Error: " + e.message; }
        }

        // Load existing
        window.onload = async () => {
            const savedIp = localStorage.getItem("esp32_ip");
            if(savedIp) document.getElementById('espIp').value = savedIp;
            const res = await fetch(FB);
            const d = await res.json();
            if(d) {
                tLow.value = d.tempLow; tHigh.value = d.tempHigh;
                hLow.value = d.humLow; hHigh.value = d.humHigh;
                updateUI();
            }
        };
    </script>
</body>
</html>