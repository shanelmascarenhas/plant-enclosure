<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Control</title>
    <style>
        :root { --bg: #0b0f0c; --card: rgba(255,255,255,0.05); --text: rgba(255,255,255,0.92); --muted: rgba(255,255,255,0.6); --stroke: rgba(255,255,255,0.12); --radius: 18px; --accent: #4f99ff; }
        body { margin: 0; background: radial-gradient(1200px 800px at 85% 20%, rgba(79, 153, 255, 0.15), transparent 60%), var(--bg); color: var(--text); font-family: system-ui, sans-serif; padding: 30px 20px 60px 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .header { max-width: 600px; width: 100%; margin: 0 auto 30px auto; text-align: center; position: relative; }
        .back-btn { position: absolute; left: 0; top: 50%; transform: translateY(-50%); color: var(--muted); text-decoration: none; font-size: 14px; transition: color 0.2s; }
        .back-btn:hover { color: white; }
        h2 { margin: 0; font-weight: 400; font-size: 26px; }

        .form-container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 20px; }
        .control-group { background: var(--card); border: 1px solid var(--stroke); border-radius: var(--radius); padding: 24px; backdrop-filter: blur(10px); }
        .group-title { font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); margin-bottom: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px; }

        .input-box { display: flex; flex-direction: column; gap: 6px; margin-bottom: 20px; }
        .input-box label { font-size: 12px; color: var(--muted); }
        .input-box input[type="text"] { background: rgba(0,0,0,0.3); border: 1px solid var(--stroke); color: white; padding: 12px; border-radius: 12px; font-size: 16px; outline: none; transition: 0.2s; }
        
        /* Dual Slider CSS */
        .slider-container { margin-bottom: 24px; }
        .slider-labels { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 12px; color: var(--text); }
        .slider-labels span.val { font-weight: bold; color: var(--accent); }
        
        .dual-slider { position: relative; width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 10px; }
        .slider-track { position: absolute; height: 100%; background: var(--accent); border-radius: 3px; z-index: 1; }
        .dual-slider input[type="range"] { position: absolute; width: 100%; -webkit-appearance: none; background: none; pointer-events: none; top: -6px; z-index: 2; margin: 0; }
        .dual-slider input[type="range"]::-webkit-slider-thumb { pointer-events: auto; -webkit-appearance: none; width: 18px; height: 18px; background: white; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        .btn { appearance: none; border: none; background: rgba(79, 153, 255, 0.2); border: 1px solid rgba(79, 153, 255, 0.4); color: white; padding: 16px; border-radius: 14px; font-weight: 600; font-size: 16px; cursor: pointer; transition: 0.2s; width: 100%; }
        .btn:hover { background: rgba(79, 153, 255, 0.3); }
        #statusMsg { text-align: center; font-size: 13px; margin-top: 12px; color: var(--muted); min-height: 20px; }
        #loadingOverlay { text-align: center; padding: 40px; color: var(--accent); font-weight: bold; display: none; }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html" class="back-btn">‚Üê Home</a>
        <h2>Control Panel</h2>
    </div>

    <div id="loadingOverlay">Connecting to Cloud Database...</div>

    <div class="form-container" id="formWrapper" style="display: none;">
        
        <div class="control-group">
            <div class="group-title">üîå Device Connection</div>
            <div class="input-box">
                <label>ESP32 IP Address</label>
                <input type="text" id="espIp" placeholder="e.g. 192.168.1.100">
            </div>
        </div>

        <div class="control-group">
            <div class="group-title">üå°Ô∏è Environment Ranges</div>
            
            <div class="slider-container">
                <div class="slider-labels"><span>Temperature</span> <span class="val" id="tempVal">65¬∞F - 85¬∞F</span></div>
                <div class="dual-slider">
                    <div class="slider-track" id="tempTrack"></div>
                    <input type="range" id="tempLow" min="40" max="100" value="65" step="1" oninput="updateSliders('temp')">
                    <input type="range" id="tempHigh" min="40" max="100" value="85" step="1" oninput="updateSliders('temp')">
                </div>
            </div>

            <div class="slider-container">
                <div class="slider-labels"><span>Humidity</span> <span class="val" id="humVal">40% - 60%</span></div>
                <div class="dual-slider">
                    <div class="slider-track" id="humTrack"></div>
                    <input type="range" id="humLow" min="0" max="100" value="40" step="1" oninput="updateSliders('hum')">
                    <input type="range" id="humHigh" min="0" max="100" value="60" step="1" oninput="updateSliders('hum')">
                </div>
            </div>

            <div class="slider-container">
                <div class="slider-labels"><span>Soil Moisture</span> <span class="val" id="soilVal">20% - 50%</span></div>
                <div class="dual-slider">
                    <div class="slider-track" id="soilTrack"></div>
                    <input type="range" id="soilLow" min="0" max="100" value="20" step="1" oninput="updateSliders('soil')">
                    <input type="range" id="soilHigh" min="0" max="100" value="50" step="1" oninput="updateSliders('soil')">
                </div>
            </div>
        </div>

        <div class="control-group">
            <div class="group-title">üåû Lighting Cycle</div>
            
            <div class="slider-container">
                <div class="slider-labels"><span>Turn On Time</span> <span class="val" id="onVal">08:00</span></div>
                <div class="dual-slider"><div class="slider-track" style="width:100%"></div>
                    <input type="range" id="timeOnHour" min="0" max="23" value="8" oninput="updateSingles()">
                </div>
            </div>

            <div class="slider-container">
                <div class="slider-labels"><span>Turn Off Time</span> <span class="val" id="offVal">20:00</span></div>
                <div class="dual-slider"><div class="slider-track" style="width:100%"></div>
                    <input type="range" id="timeOffHour" min="0" max="23" value="20" oninput="updateSingles()">
                </div>
            </div>

            <div class="slider-container">
                <div class="slider-labels"><span>Lux Threshold</span> <span class="val" id="luxVal">30000 lux</span></div>
                <div class="dual-slider"><div class="slider-track" style="width:100%"></div>
                    <input type="range" id="luxThreshold" min="0" max="100000" step="1000" value="30000" oninput="updateSingles()">
                </div>
            </div>
        </div>

        <button class="btn" id="sendBtn">üì° Push Settings</button>
        <div id="statusMsg">Ready to update.</div>
    </div>

    <script>
        // FIREBASE URL
        const FIREBASE_URL = ""https://plant-enclosure-default-rtdb.firebaseio.com/settings.json"; 

        const inputs = {
            espIp: document.getElementById("espIp"), tempLow: document.getElementById("tempLow"), tempHigh: document.getElementById("tempHigh"),
            humLow: document.getElementById("humLow"), humHigh: document.getElementById("humHigh"), soilLow: document.getElementById("soilLow"),
            soilHigh: document.getElementById("soilHigh"), timeOnHour: document.getElementById("timeOnHour"), timeOffHour: document.getElementById("timeOffHour"), luxThreshold: document.getElementById("luxThreshold")
        };

        const savedIp = localStorage.getItem("esp32_ip");
        if (savedIp) inputs.espIp.value = savedIp;

        // UI Logic for Dual Sliders
        function updateSliders(type) {
            const low = document.getElementById(type + "Low");
            const high = document.getElementById(type + "High");
            const track = document.getElementById(type + "Track");
            const label = document.getElementById(type + "Val");
            const suffix = type === 'temp' ? '¬∞F' : '%';

            let minV = parseInt(low.value);
            let maxV = parseInt(high.value);

            if (minV >= maxV) { low.value = maxV - 1; minV = maxV - 1; }

            const minBound = parseInt(low.min);
            const maxBound = parseInt(low.max);
            
            const percent1 = ((minV - minBound) / (maxBound - minBound)) * 100;
            const percent2 = ((maxV - minBound) / (maxBound - minBound)) * 100;

            track.style.left = percent1 + "%";
            track.style.width = (percent2 - percent1) + "%";
            label.textContent = `${minV}${suffix} - ${maxV}${suffix}`;
        }

        // UI Logic for Single Sliders
        function updateSingles() {
            document.getElementById("onVal").textContent = document.getElementById("timeOnHour").value.padStart(2, '0') + ":00";
            document.getElementById("offVal").textContent = document.getElementById("timeOffHour").value.padStart(2, '0') + ":00";
            document.getElementById("luxVal").textContent = document.getElementById("luxThreshold").value + " lux";
        }

        async function fetchCurrentSettings() {
            document.getElementById("loadingOverlay").style.display = "block";
            try {
                const response = await fetch(FIREBASE_URL, { cache: "no-store" });
                if (!response.ok) throw new Error("Could not connect to Firebase");
                const settings = await response.json();
                if (settings) {
                    for (const key in settings) {
                        if (inputs[key] !== undefined) inputs[key].value = settings[key];
                    }
                }
                // Trigger UI updates to paint the tracks
                updateSliders('temp'); updateSliders('hum'); updateSliders('soil'); updateSingles();
                
                document.getElementById("loadingOverlay").style.display = "none"; 
                document.getElementById("formWrapper").style.display = "flex";
            } catch (err) {
                document.getElementById("loadingOverlay").innerHTML = `‚ùå Connection Failed<br><small style="color:white">${err.message}</small>`;
            }
        }

        document.getElementById("sendBtn").addEventListener("click", async () => {
            let targetIp = inputs.espIp.value.trim();
            if (!targetIp) { alert("Please enter the ESP32 IP Address!"); inputs.espIp.focus(); return; }
            if (!targetIp.startsWith("http")) targetIp = "http://" + targetIp;

            const sendBtn = document.getElementById("sendBtn");
            const statusMsg = document.getElementById("statusMsg");

            sendBtn.disabled = true; sendBtn.textContent = "Uploading...";
            localStorage.setItem("esp32_ip", inputs.espIp.value.trim());

            try {
                const newSettings = {
                    tempLow: parseFloat(inputs.tempLow.value), tempHigh: parseFloat(inputs.tempHigh.value),
                    humLow: parseFloat(inputs.humLow.value), humHigh: parseFloat(inputs.humHigh.value),
                    soilLow: parseInt(inputs.soilLow.value), soilHigh: parseInt(inputs.soilHigh.value),
                    timeOnHour: parseInt(inputs.timeOnHour.value), timeOffHour: parseInt(inputs.timeOffHour.value),
                    luxThreshold: parseInt(inputs.luxThreshold.value)
                };

                statusMsg.textContent = "Pushing to ESP32...";
                const espRes = await fetch(`${targetIp}/settings`, {
                    method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(newSettings)
                });
                if (!espRes.ok) throw new Error("ESP32 refused connection.");

                statusMsg.textContent = "ESP32 Updated! Syncing to Cloud...";
                const putResp = await fetch(FIREBASE_URL, {
                    method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(newSettings)
                });
                if (!putResp.ok) throw new Error("Firebase Sync Failed");

                statusMsg.textContent = "‚úÖ Enclosure & Cloud successfully updated!";
                sendBtn.textContent = "Update Successful"; sendBtn.style.background = "#2cff8a"; sendBtn.style.color = "#000"; 
                setTimeout(() => {
                    sendBtn.disabled = false; sendBtn.textContent = "üì° Push Settings";
                    sendBtn.style.background = "rgba(79, 153, 255, 0.2)"; sendBtn.style.color = "white"; 
                }, 3000);
            } catch (err) {
                statusMsg.innerHTML = `‚ùå Error: ${err.message}`;
                sendBtn.disabled = false; sendBtn.textContent = "Try Again";
            }
        });

        fetchCurrentSettings();
    </script>
</body>
</html>